name: Release Axxon Automation

on:
  push:
    branches: [main]
    tags:
      - '!v*'  # Skip tag pushes to avoid loops

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      LP_GPG_KEY: ${{ secrets.LP_GPG_KEY }}
      LP_GPG_PASSPHRASE: ${{ secrets.LP_GPG_PASSPHRASE }}
      LP_USERNAME: ${{ secrets.LP_USERNAME }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next version
        id: version
        run: |
          git fetch --tags --quiet
          latest=$(git tag --sort=-v:refname | head -n 1)
          if [ -z "$latest" ]; then
            next="1.0-1"
          else
            version=${latest#v}
            base=${version%-*}
            rev=${version##*-}
            if [ -z "$base" ] || [ "$base" = "$version" ]; then
              base="$version"
              rev="0"
            fi
            rev=$((rev + 1))
            next="$base-$rev"
          fi
          echo "version=$next" >> "$GITHUB_OUTPUT"

      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential devscripts debhelper dput gnupg

      - name: Build Debian package
        env:
          PACKAGE_VERSION: ${{ steps.version.outputs.version }}
        run: |
          ./scripts/build_deb.sh
          echo "Package: $(ls dist/axxon-automation_*.deb)"

      - name: Sign source packages for Launchpad
        if: env.LP_GPG_KEY != ''
        env:
          GNUPGHOME: /tmp/gnupg
        run: |
          mkdir -p "$GNUPGHOME"
          chmod 700 "$GNUPGHOME"
          printf '%s' "$LP_GPG_KEY" | gpg --batch --import
          debsign -k "$LP_USERNAME" -p"gpg --batch --pinentry-mode loopback --passphrase $LP_GPG_PASSPHRASE" ../axxon-automation_*_source.changes

      - name: Upload to Launchpad PPA
        if: env.LP_GPG_KEY != ''
        run: |
          dput ppa:letsconnectzohaib/axxon ../axxon-automation_*_source.changes

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          target_commitish: ${{ github.sha }}
          name: "Axxon Automation v${{ steps.version.outputs.version }}"
          body: |
            Automated installer package for:
            - Google Chrome
            - Slack
            - Opera
          files: dist/axxon-automation_*.deb
          draft: false
          prerelease: false
          generate_release_notes: true
          overwrite_files: true
