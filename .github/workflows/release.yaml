name: Create Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    name: Build assets and publish release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate release metadata
        id: meta
        run: |
          DATE_TAG="$(date -u +'%Y.%m.%d')"
          TAG_NAME="auto-v${DATE_TAG}-${GITHUB_RUN_NUMBER}"
          RELEASE_NAME="Automated Release ${TAG_NAME}"
          echo "tag_name=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "release_name=${RELEASE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Set up workspace paths
        run: |
          mkdir -p dist

      - name: Package installer
        run: |
          tar czf dist/axx-install-scripts.tar.gz install_apps.sh lib README.md .gitignore
          zip -r dist/axx-install-scripts.zip install_apps.sh lib README.md .gitignore

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.meta.outputs.tag_name }}
          name: ${{ steps.meta.outputs.release_name }}
          files: |
            dist/axx-install-scripts.tar.gz
            dist/axx-install-scripts.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
